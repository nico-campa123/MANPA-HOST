<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MANPA Tech</title>
   <link href="https://fonts.googleapis.com/css2?family=Overpass&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- React + ReactDOM + Babel (for small dev/demo without build step) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <!-- React application (Babel will compile the JSX in-browser) -->
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      // Ensure Chart.js uses the same font as the page
      Chart.defaults.font.family = "Overpass, sans-serif";
      const [predictions, setPredictions] = useState([]);
      const [raw, setRaw] = useState(null);
      const fileRef = useRef();
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

    useEffect(() => {
        // draw or update chart when predictions change
        const ctx = chartRef.current && chartRef.current.getContext('2d');
        if (!ctx) return;
        const zeros = predictions.filter(p => Number(p[1]) === 0).length;
        const ones = predictions.filter(p => Number(p[1]) === 1).length;
        const data = [zeros, ones];

        if (chartInstance.current) {
          chartInstance.current.data.datasets[0].data = data;
          chartInstance.current.update();
        } else {
          chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Zeros', 'Ones'],
              datasets: [{
                label: 'Count',
                data,
                backgroundColor: ['rgba(201,203,207,0.8)', 'rgba(54,162,235,0.8)'],
                borderColor: ['rgba(201,203,207,1)', 'rgba(54,162,235,1)'],
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, color: '#fff' }, grid: { color: 'rgba(255,255,255,0.08)' } },
                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.03)' } }
              },
              plugins: { legend: { labels: { color: '#fff' } }, title: { display: false } }
            }
          });
        }
      }, [predictions]);

      async function upload() {
        const file = fileRef.current.files[0];
        if (!file) return alert('Select a CSV first');
        const formData = new FormData();
        formData.append('file', file);
        try {
          const res = await fetch('https://python-test-2-vwex.onrender.com/upload-csv/', { method: 'POST', body: formData });
          if (!res.ok) throw new Error('Server error: ' + res.status);
          const j = await res.json();
          setRaw(j);
          // try to normalize predictions into [[id,pred], ...]
          let pairs = [];
          // Normalize many possible server shapes into [[id,pred], ...]
          if (Array.isArray(j.predictions)) {
            // common: [[id, pred], ...] or [{id, pred}, ...]
            if (j.predictions.length && typeof j.predictions[0] === 'object' && !Array.isArray(j.predictions[0])) {
              pairs = j.predictions.map((it, i) => [it.id ?? it.ID ?? i, it.pred ?? it.prediction ?? it.value ?? null]);
            } else {
              pairs = j.predictions;
            }
          } else if (j.predictions && typeof j.predictions === 'object') {
            // map of id->pred
            pairs = Object.keys(j.predictions).map(k => [k, j.predictions[k]]);
          } else if (Array.isArray(j) && j.length) {
            // maybe the root is the array
            pairs = j;
          } else {
            pairs = [];
          }
          setPredictions(pairs);
        } catch (e) {
          console.error(e);
          alert('Upload failed: ' + e.message);
        }
      }

      function downloadCSV(pairs){
        if (!pairs || !pairs.length) return alert('No predictions to download');
        const lines = ['id,pred', ...pairs.map(p => `${String(p[0]).replace(/,/g,'')},${String(p[1]).replace(/\n/g,' ')}`)];
        const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'predictions.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      return (
        <div className="app">
          <h1 className="site-title">MANPA Tech™</h1>
          <div>
            <h3>Input CSV file</h3>
            <input type="file" ref={fileRef} accept=".csv" />
            <button className="btn" onClick={upload}>Upload CSV</button>
            <button className="btn" onClick={() => downloadCSV(predictions)}>Download predictions</button>
          </div>

          <div className="container">
            <canvas id="myChart" ref={chartRef}></canvas>
          </div>

          <h2>Predictions</h2>
          <PredictionsTable data={predictions} />
        </div>
      );
    }

    function PredictionsTable({data}){
      const [sortBy, setSortBy] = React.useState('id');
      const [dir, setDir] = React.useState('asc');
      const [query, setQuery] = React.useState('');
      const [page, setPage] = React.useState(1);
      const pageSize = 12;

      const filtered = React.useMemo(() => {
        const q = query.trim().toLowerCase();
        return data.filter(d => {
          if (!q) return true;
          const id = String(d[0]).toLowerCase();
          const pred = String(d[1]).toLowerCase();
          return id.includes(q) || pred.includes(q);
        });
      }, [data, query]);

      const rows = React.useMemo(() => {
        const copy = filtered.map(d => ({ id: String(d[0]), pred: d[1] }));
        copy.sort((a,b) => {
          let A = sortBy === 'id' ? a.id : Number(a.pred);
          let B = sortBy === 'id' ? b.id : Number(b.pred);
          if (A < B) return dir === 'asc' ? -1 : 1;
          if (A > B) return dir === 'asc' ? 1 : -1;
          return 0;
        });
        return copy;
      }, [filtered, sortBy, dir]);

      const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
      const pageRows = rows.slice((page-1)*pageSize, page*pageSize);

      function toggle(column){
        if (sortBy === column) setDir(d => d === 'asc' ? 'desc' : 'asc');
        else { setSortBy(column); setDir('asc'); }
      }

      React.useEffect(() => { setPage(1); }, [query, sortBy, dir]);

      return (
        <div>
          <div className="table-controls">
            <input className="search-input" placeholder="Search id or prediction" value={query} onChange={e=>setQuery(e.target.value)} />
            <div style={{flex:1}} />
            <div className="pagination">
              <button className="page-btn" onClick={()=>setPage(1)} disabled={page===1}>«</button>
              <button className="page-btn" onClick={()=>setPage(p=>Math.max(1,p-1))} disabled={page===1}>‹</button>
              <div style={{color:'#cfeaf7'}}>{page} / {totalPages}</div>
              <button className="page-btn" onClick={()=>setPage(p=>Math.min(totalPages,p+1))} disabled={page===totalPages}>›</button>
              <button className="page-btn" onClick={()=>setPage(totalPages)} disabled={page===totalPages}>»</button>
            </div>
          </div>

          <div style={{overflowX: 'auto'}}>
            <table style={{width: '100%', borderCollapse: 'collapse'}}>
              <thead>
                <tr>
                  <th style={{textAlign: 'left', cursor: 'pointer'}} onClick={() => toggle('id')}>ID {sortBy==='id' ? (dir==='asc' ? '▲' : '▼') : ''}</th>
                  <th style={{textAlign: 'left', cursor: 'pointer'}} onClick={() => toggle('pred')}>Prediction {sortBy==='pred' ? (dir==='asc' ? '▲' : '▼') : ''}</th>
                </tr>
              </thead>
              <tbody>
                {pageRows.map((r, i) => (
                  <tr key={i} className={Number(r.pred)===1 ? 'highlight' : ''} style={{borderTop: '1px solid rgba(255,255,255,0.06)'}}>
                    <td style={{padding: '8px 6px'}}>{r.id}</td>
                    <td style={{padding: '8px 6px'}}>{r.pred}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function Landing({onStart}){
      return (
        <div className="hero">
          <h1>AI Exoplanet detection system</h1>
          <p>Upload a csv of any detected object by KEPLER satellite and know if it is an Exoplanet</p>
          <button className="start-btn" onClick={onStart}>Ejecutar .csv</button>
        </div>
      );
    }

    function RootApp(){
      const [started, setStarted] = React.useState(false);
      return started ? <App /> : <Landing onStart={() => setStarted(true)} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<RootApp />);
  </script>
</body>
</html>
